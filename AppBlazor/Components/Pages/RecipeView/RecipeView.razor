@page "/recipe-view/{RecipeId:int}"
@using Core.Entities
@rendermode InteractiveServer
@attribute [StreamRendering]
@using Microsoft.AspNetCore.Components.Authorization

<div class="container mt-4">

    <h2 class="text-center fw-bold mb-4">@RecipeName</h2>

    <div class="row" style="display: grid; justify-items: center;">

        <div class="col-md-5 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white fw-bold">
                    @L["Ingredients"]
                </div>

                <ul class="list-group list-group-flush">
                    @foreach (var ingredient in recipeIngredients)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">@ingredient.ingredient</span>
                            <span class="badge bg-secondary">
                                @ingredient.amount @ingredient.measure
                            </span>
                        </li>
                    }
                </ul>
            </div>
        </div>

        <div class="col-md-7 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
                    <span>@L["Steps"]</span>
                    <span class="badge bg-light text-dark">
                        @(currentStepIndex + 1) / @steps.Count
                    </span>
                </div>

                @if (steps != null && steps.Any())
                {
                    var step = steps[currentStepIndex];
                    bool isCompleted = verifyCompletedStep(step.Id);

                    <div class="card-body" id="cardBody">

                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="fw-bold mb-0">@step.Name</h4>

                            @if (isCompleted)
                            {
                                <span class="badge bg-success">✅ @L["Completed"]</span>
                            }
                        </div>

                        <p class="text-muted mt-2">@step.Description</p>
                        @if(step.Duration > 0)
                        {
                            <span class="badge bg-info text-dark mb-3">
                                @L["Duration"]: @step.Duration m
                            </span>
                            <div id="temp-container">
                                <div id="temp-options">

                                    <button class="btn btn-outline-info" @onclick="() => startPause(step.Id)">@play_pause</button>
                                    <button class="btn btn-outline-info" @onclick="() => reset(step.Id)">⟳</button>
                                </div>
                                <div id="temp-value">
                                    @step.timerValue
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(step.imageURL))
                        {
                            <img src="@step.imageURL"
                                class="img-fluid rounded mt-3 shadow-sm"
                                style="max-height:320px; object-fit:cover;"
                                alt="@step.Name" />
                        }

                        <div class="mt-4">
                            <label class="form-label fw-semibold">
                                @L["Your notes for this step"]
                            </label>

                            <textarea class="form-control"
                                    rows="3"
                                    placeholder="@L["Write your notes here..."]"
                                    @bind="@step.note">
                            </textarea>
                        </div>
                        <button
                        class="btn btn-info"
                        @onclick="() => saveComment(step.Id)"
                        type="button">
                        Guardar
                        </button>

                        <div class="mt-4">
                            <button class="btn btn-outline-success w-100"
                                    @onclick="() => MarkStep(step.Id, true)"
                                    disabled="@isCompleted">
                                @(isCompleted ? L["Step completed"] : L["Mark as completed"])
                            </button>
                        </div>
                        @if(@isCompleted)
                        {
                            <div class="mt-4">
                                <button class="btn btn-outline-warning w-100"
                                        @onclick="() => MarkStep(step.Id, false)">
                                    @(isCompleted ? L["Uncomplete Step"] : true)
                                </button>
                            </div>
                        }
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <button class="btn btn-outline-secondary"
                                    @onclick="PreviousStep"
                                    disabled="@(currentStepIndex == 0)">
                                ◀ @L["Previous"]
                            </button>

                            <button class="btn btn-outline-success"
                                    @onclick="NextStep"
                                    disabled="@(currentStepIndex == steps.Count - 1)">
                                @L["Next"] ▶
                            </button>
                        </div>

                    </div>
                }
                else
                {
                    <div class="card-body text-muted">
                        @L["No steps available"]
                    </div>
                }
            </div>
        </div>
    </div>
</div>
